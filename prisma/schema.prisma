// Prisma schema for Kpsull - SaaS marketplace for French creators
// Auth.js compatible with hexagonal architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  CLIENT
  CREATOR
  ADMIN
}

enum Plan {
  ESSENTIEL  // 29€/mois ou 290€/an - Commission 5% - 10 produits
  STUDIO     // 79€/mois ou 790€/an - Commission 4% - 20 produits
  ATELIER    // 95€/mois ou 950€/an - Commission 3% - Illimite
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  VALIDATION_PENDING
  COMPLETED
  DISPUTE_OPENED
  RETURN_SHIPPED
  RETURN_RECEIVED
  REFUNDED
  CANCELED
}

enum SectionType {
  HERO
  ABOUT
  BENTO_GRID
  PRODUCTS_FEATURED
  PRODUCTS_GRID
  TESTIMONIALS
  CONTACT
  CUSTOM
}

enum FlagReason {
  INAPPROPRIATE_CONTENT
  COUNTERFEIT
  PROHIBITED_ITEM
  MISLEADING_DESCRIPTION
  SPAM
  OTHER
}

enum ModerationStatus {
  PENDING
  APPROVED
  HIDDEN
  DELETED
}

enum ModerationActionType {
  APPROVE
  HIDE
  DELETE
}

// ============================================
// USER & AUTH (Auth.js compatible)
// ============================================

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  emailVerified  DateTime?
  name           String?
  image          String?
  hashedPassword String?   // For email/password auth (null for OAuth-only users)
  role           Role      @default(CLIENT)

  // Account type flags
  accountTypeChosen Boolean @default(false)
  wantsToBeCreator  Boolean @default(false)

  // OAuth (Auth.js)
  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Moderation relations
  flaggedContentCreated     FlaggedContent[]        @relation("FlaggedContentCreator")
  flaggedContentFlagged     FlaggedContent[]        @relation("FlaggedContentFlagger")
  flaggedContentModerated   FlaggedContent[]        @relation("FlaggedContentModerator")
  moderationActions         ModerationActionRecord[] @relation("ModerationActionModerator")

  // Suspension relations
  suspensions               CreatorSuspension[]     @relation("CreatorSuspensions")
  suspensionsAdministered   CreatorSuspension[]     @relation("SuspensionAdmin")
  reactivationsAdministered CreatorSuspension[]     @relation("ReactivationAdmin")

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CREATOR ONBOARDING
// ============================================

enum OnboardingStep {
  PROFESSIONAL_INFO
  SIRET_VERIFICATION
  STRIPE_CONNECT
  COMPLETED
}

model CreatorOnboarding {
  id        String         @id @default(cuid())
  userId    String         @unique

  currentStep               OnboardingStep @default(PROFESSIONAL_INFO)
  professionalInfoCompleted Boolean        @default(false)
  siretVerified             Boolean        @default(false)
  stripeOnboarded           Boolean        @default(false)

  // Professional info
  brandName           String?
  siret               String?
  professionalAddress String?

  // Stripe
  stripeAccountId String?

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@map("creator_onboardings")
}

// ============================================
// SUBSCRIPTIONS
// ============================================

model Subscription {
  id        String             @id @default(cuid())
  userId    String             @unique
  creatorId String             @unique

  plan                Plan               @default(ESSENTIEL)
  status              SubscriptionStatus @default(ACTIVE)
  billingInterval     String             @default("year") // "month" or "year"
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEnd    DateTime

  // Plan limits tracking
  productsUsed        Int                @default(0)
  pinnedProductsUsed  Int                @default(0)

  // Commission rate based on plan (stored for historical accuracy)
  commissionRate      Float              @default(0.05) // 5% for Essentiel

  // Trial period (14 days for Atelier)
  trialStart          DateTime?
  trialEnd            DateTime?
  isTrialing          Boolean            @default(false)

  // Stripe
  stripeSubscriptionId String?
  stripeCustomerId     String?
  stripePriceId        String?

  // Grace period for failed payments
  gracePeriodStart     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([creatorId])
  @@index([plan])
  @@map("subscriptions")
}

// ============================================
// CREATOR PAGE & SECTIONS
// ============================================

enum PageStatus {
  DRAFT
  PUBLISHED
}

model CreatorPage {
  id          String     @id @default(cuid())
  creatorId   String     @unique
  slug        String     @unique
  title       String
  description String?
  templateId  String?
  status      PageStatus @default(DRAFT)
  publishedAt DateTime?

  sections PageSection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@map("creator_pages")
}

model PageSection {
  id        String      @id @default(cuid())
  pageId    String
  type      SectionType
  title     String
  content   Json        @default("{}")
  position  Int         @default(0)
  isVisible Boolean     @default(true)

  page CreatorPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId])
  @@index([position])
  @@map("page_sections")
}

// ============================================
// ORDERS
// ============================================

model Order {
  id                    String      @id @default(cuid())
  orderNumber           String      @unique
  creatorId             String
  customerId            String
  customerName          String
  customerEmail         String

  status                OrderStatus @default(PENDING)
  totalAmount           Int         // in cents

  // Shipping address (stored as separate fields)
  shippingStreet        String
  shippingCity          String
  shippingPostalCode    String
  shippingCountry       String

  // Stripe integration
  stripePaymentIntentId String?
  stripeRefundId        String?

  // Shipping info
  trackingNumber        String?
  carrier               String?

  // Cancellation/refund
  cancellationReason    String?

  // Timeline
  shippedAt             DateTime?
  deliveredAt           DateTime?

  items          OrderItem[]
  returnRequests ReturnRequest[]
  disputes       Dispute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String
  variantId   String?
  productName String
  variantInfo String?
  price       Int     // in cents
  quantity    Int
  image       String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============================================
// PRODUCTS & PROJECTS
// ============================================

model Project {
  id          String  @id @default(cuid())
  creatorId   String
  name        String
  description String?
  coverImage  String?

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@map("projects")
}

model Product {
  id          String        @id @default(cuid())
  creatorId   String
  projectId   String?
  name        String
  description String?
  price       Int           // in cents
  currency    String        @default("EUR")
  status      ProductStatus @default(DRAFT)
  publishedAt DateTime?

  project  Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  variants ProductVariant[]
  images   ProductImage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([projectId])
  @@index([status])
  @@map("products")
}

model ProductVariant {
  id            String  @id @default(cuid())
  productId     String
  name          String
  sku           String?
  priceOverride Int?    // in cents, if different from product price
  stock         Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, sku])
  @@index([productId])
  @@map("product_variants")
}

model ProductImage {
  id        String @id @default(cuid())
  productId String
  url       String
  alt       String @default("")
  position  Int    @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([position])
  @@map("product_images")
}

// ============================================
// RETURNS & DISPUTES
// ============================================

enum ReturnStatus {
  REQUESTED
  APPROVED
  SHIPPED_BACK
  RECEIVED
  REFUNDED
  REJECTED
}

enum ReturnReason {
  CHANGED_MIND
  DEFECTIVE
  NOT_AS_DESCRIBED
  OTHER
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum DisputeType {
  NOT_RECEIVED
  DAMAGED
  WRONG_ITEM
  OTHER
}

model ReturnRequest {
  id              String       @id @default(cuid())
  orderId         String
  customerId      String
  creatorId       String
  reason          ReturnReason
  additionalNotes String?
  status          ReturnStatus @default(REQUESTED)
  rejectionReason String?

  // Return shipping (client -> creator)
  trackingNumber String?
  carrier        String?

  // Timeline
  deliveredAt DateTime  // Date de livraison originale
  approvedAt  DateTime?
  rejectedAt  DateTime?
  shippedAt   DateTime? // Quand le client a expedie le retour
  receivedAt  DateTime? // Quand le createur a recu le retour
  refundedAt  DateTime?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([customerId])
  @@index([creatorId])
  @@index([status])
  @@map("return_requests")
}

model Dispute {
  id          String        @id @default(cuid())
  orderId     String
  customerId  String
  creatorId   String
  type        DisputeType
  description String
  status      DisputeStatus @default(OPEN)
  resolution  String?

  // Timeline
  resolvedAt DateTime?
  closedAt   DateTime?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([customerId])
  @@index([creatorId])
  @@index([status])
  @@map("disputes")
}

// ============================================
// CONTENT MODERATION
// ============================================

model FlaggedContent {
  id                 String           @id @default(cuid())
  contentId          String
  contentType        String           // 'PRODUCT' | 'REVIEW' | 'PAGE'
  contentTitle       String
  contentDescription String?
  contentImageUrl    String?
  creatorId          String
  creator            User             @relation("FlaggedContentCreator", fields: [creatorId], references: [id])
  flaggedBy          String
  flagger            User             @relation("FlaggedContentFlagger", fields: [flaggedBy], references: [id])
  flagReason         FlagReason
  flagDetails        String?
  status             ModerationStatus @default(PENDING)
  moderatorId        String?
  moderator          User?            @relation("FlaggedContentModerator", fields: [moderatorId], references: [id])
  moderatorNote      String?
  flaggedAt          DateTime         @default(now())
  moderatedAt        DateTime?

  actions ModerationActionRecord[]

  @@index([status])
  @@index([creatorId])
  @@index([contentType])
  @@map("flagged_content")
}

model ModerationActionRecord {
  id               String               @id @default(cuid())
  flaggedContentId String
  flaggedContent   FlaggedContent       @relation(fields: [flaggedContentId], references: [id], onDelete: Cascade)
  action           ModerationActionType
  moderatorId      String
  moderator        User                 @relation("ModerationActionModerator", fields: [moderatorId], references: [id])
  note             String?
  createdAt        DateTime             @default(now())

  @@index([flaggedContentId])
  @@index([moderatorId])
  @@map("moderation_actions")
}

// ============================================
// CREATOR SUSPENSION (AUDIT TRAIL)
// ============================================

model CreatorSuspension {
  id                 String    @id @default(cuid())
  creatorId          String
  creator            User      @relation("CreatorSuspensions", fields: [creatorId], references: [id])
  suspendedBy        String
  suspender          User      @relation("SuspensionAdmin", fields: [suspendedBy], references: [id])
  reason             String
  suspendedAt        DateTime  @default(now())
  reactivatedAt      DateTime?
  reactivatedBy      String?
  reactivator        User?     @relation("ReactivationAdmin", fields: [reactivatedBy], references: [id])
  reactivationReason String?

  @@index([creatorId])
  @@map("creator_suspensions")
}
